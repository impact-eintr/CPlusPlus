## C++语言特性性能分析

### 屁话

通常大多数开发人员认为，汇编语言和C语言比较适合编写对性能要求非常高的程序，

C++语言主要适用于编写复杂度非常高但性能要求并不是很高的程序。因为大多数开发人员认为，C++语言设计时因为考虑到支持多种编程模式（如面向对象编程和范型编程）以及异常处理等，从而引入了太多新的语言特性。新的语言特性往往使得C++编译器在编译程序时插入了很多额外的代码，会导致最终生成的二进制代码体积膨胀，而且执行速度下降。
但事实并非如此，通常一个程序的速度在框架设计完成时大致已经确定，而并非因为采用C++语言才导致速度没有达到预期目标。因此，当一个程序的性能需要提高时，首先需要做的是用性能检测工具对其运行的时间分布进行一个准确的测量，找出关键路径和真正的性能瓶颈所在，然后针对性能瓶颈进行分析和优化，而不是主观地将性能问题归咎于程序所采用的语言。工程实践表明，如果框架设计不做修改，即使使用C语言或汇编语言重新改写，也并不能保证提高总体性能。
因此，遇到性能问题时，首先应检查和反思程序的总体架构，然后使用性能检测工具对其实际运行做准确的测量，再针对性能瓶颈进行分析和优化。





### 重点

但C++语言中确实有一些操作、特性比其它因素更容易成为程序的性能瓶颈，常见因素如下：
（1）缺页
缺页通常意味着要访问外部存储，因为外部存储访问相对于访问内存或代码执行，有数量级的差别。因此，只要有可能，应该尽量想办法减少缺页。
（2）从堆中动态申请和释放内存
C语言中的malloc/free和C++语言中的new/delete操作时非常耗时的，因此要尽可能优先考虑从线程栈中获取内存。优先考虑栈而减少从动态堆中申请内存，不仅因为在堆中分配内存比在栈中要慢很多，而且还与尽量减少缺页有关。当程序执行时，**当前栈帧空间所在的内存页肯定在物理内存中**，因此程序代码对其中变量的存取不会引起缺页；如果从堆空间生成对象，只有指向对象的指针在栈上，对象本身则存储在堆空间中。堆一般不可能都在物理内存中，而且由于堆分配内存的特性，即使两个相邻生成的对象，也很有可能在堆内存位置上相距很远。因此，当访问两个对象时，虽然分别指向两个对象的指针都在栈上，但通过两个指针引用对象时很有可能会引起两次缺页。
（3）复杂对象的创建和销毁
复杂对象的创建和销毁会比较耗时，因此对于层次较深的递归调用需要重点关注递归内部的对象创建。其次，编译器生成的临时对象因为在程序的源码中看不到，更不容易察觉，因此需要重点关注。
（4）函数调用
由于函数调用有固定的额外开销，因此当函数体的代码量相对较少，并且函数被非常频繁调用时，函数调用时的固定开销容易成为不必要的开销。C语言的宏和C++的内联函数都是为了在保持函数调用的模块化特征基础上**消除函数调用的固定额外开销**而引入的。由于C语言的宏在性能优势的同时也给开发和调试带来不便，因此C++语言中推荐使用内联函数。

